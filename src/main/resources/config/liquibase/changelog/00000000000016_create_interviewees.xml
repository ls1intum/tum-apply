<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

  <!--
      Creates the interviewees table to link applications to interview processes.
      An interviewee represents an applicant who has been added to an interview process.
  -->
  <changeSet id="016-create-interviewees-table" author="abinayasivaguru">
    <createTable tableName="interviewees">
      <column name="id" type="uuid">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="interview_process_id" type="uuid">
        <constraints nullable="false"/>
      </column>
      <column name="application_id" type="uuid">
        <constraints nullable="false"/>
      </column>
      <column name="last_invited" type="timestamp">
        <constraints nullable="true"/>
      </column>
      <!-- Audit columns from AbstractAuditingEntity -->
      <column name="created_at" type="timestamp">
        <constraints nullable="false"/>
      </column>
      <column name="last_modified_at" type="timestamp">
        <constraints nullable="true"/>
      </column>
    </createTable>

    <!-- Foreign key to interview_processes -->
    <addForeignKeyConstraint
      constraintName="fk_interviewee_interview_process"
      baseTableName="interviewees"
      baseColumnNames="interview_process_id"
      referencedTableName="interview_processes"
      referencedColumnNames="id"
      onDelete="CASCADE"/>

    <!-- Foreign key to applications -->
    <addForeignKeyConstraint
      constraintName="fk_interviewee_application"
      baseTableName="interviewees"
      baseColumnNames="application_id"
      referencedTableName="applications"
      referencedColumnNames="application_id"
      onDelete="CASCADE"/>

    <!-- Unique constraint: One interviewee per application per interview process -->
    <addUniqueConstraint
      tableName="interviewees"
      columnNames="application_id, interview_process_id"
      constraintName="uk_interviewee_app_process"/>

    <!-- Index for faster lookups by interview_process_id -->
    <createIndex tableName="interviewees" indexName="idx_interviewee_process">
      <column name="interview_process_id"/>
    </createIndex>
  </changeSet>

  <!--
      Adds interviewee_id column to interview_slots table.
      This links a slot to a specific interviewee when booked.
  -->
  <changeSet id="20241205-add-interviewee-to-interview-slots" author="tumapply">
    <addColumn tableName="interview_slots">
      <column name="interviewee_id" type="uuid">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <addForeignKeyConstraint
      constraintName="fk_interview_slot_interviewee"
      baseTableName="interview_slots"
      baseColumnNames="interviewee_id"
      referencedTableName="interviewees"
      referencedColumnNames="id"
      onDelete="SET NULL"/>

    <!-- Index for faster lookups by interviewee_id -->
    <createIndex tableName="interview_slots" indexName="idx_slot_interviewee">
      <column name="interviewee_id"/>
    </createIndex>
  </changeSet>

</databaseChangeLog>
