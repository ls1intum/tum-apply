<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

  <changeSet id="001_create_users" author="marc-fett">
    <createTable tableName="users">
      <column name="user_id" type="CHAR(36)">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="research_group_id" type="CHAR(36)"/>
      <column name="avatar_file_id" type="CHAR(36)"/>
      <column name="email" type="TEXT">
        <constraints nullable="false"/>
      </column>
      <column name="first_name" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="last_name" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="gender" type="VARCHAR(255)"/>
      <column name="nationality" type="VARCHAR(255)"/>
      <column name="website" type="TEXT"/>
      <column name="cv_file_id" type="CHAR(36)"/>
      <column name="bachelor_certificate_id" type="CHAR(36)"/>
      <column name="master_certificate_id" type="CHAR(36)"/>
      <column name="study_degree" type="VARCHAR(255)"/>
      <column name="bachelor_study_program" type="TEXT"/>
      <column name="bachelor_gpa" type="DECIMAL(3,2)"/>
      <column name="master_study_program" type="TEXT"/>
      <column name="master_gpa" type="DECIMAL(3,2)"/>
      <column name="tum_student" type="BOOLEAN"/>
      <column name="linkedin_url" type="TEXT"/>
      <column name="joined_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
        <constraints nullable="false"/>
      </column>
      <column name="updated_at" type="TIMESTAMP">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <sql>
      ALTER TABLE users MODIFY updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP;
    </sql>
  </changeSet>

  <changeSet id="002_create_research_groups" author="marc-fett">
    <createTable tableName="research_groups">
      <column name="research_group_id" type="CHAR(36)">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="head" type="CHAR(36)">
        <constraints nullable="false"/>
      </column>
      <column name="name" type="TEXT">
        <constraints nullable="false"/>
      </column>
      <column name="abbreviation" type="VARCHAR(255)"/>
      <column name="email" type="TEXT"/>
      <column name="website" type="TEXT"/>
      <column name="school" type="TEXT"/>
      <column name="description" type="LONGTEXT"/>
      <column name="default_field_of_studies" type="TEXT"/>
      <column name="street" type="TEXT"/>
      <column name="postal_code" type="VARCHAR(10)"/>
      <column name="city" type="TEXT"/>
      <column name="is_archived" type="BOOLEAN" defaultValueBoolean="false">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="003_create_user_roles_and_logins" author="marc-fett">
    <createTable tableName="user_roles">
      <column name="user_id" type="CHAR(36)">
        <constraints nullable="false"/>
      </column>
      <column name="role" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="research_group_id" type="CHAR(36)"/>
    </createTable>

    <createTable tableName="user_login_providers">
      <column name="user_id" type="CHAR(36)">
        <constraints nullable="false"/>
      </column>
      <column name="login_provider" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="004_add_constraints" author="marc-fett">
    <addForeignKeyConstraint baseColumnNames="research_group_id"
                             baseTableName="users"
                             constraintName="fk_users_research_group"
                             referencedColumnNames="research_group_id"
                             referencedTableName="research_groups"/>

    <addForeignKeyConstraint baseColumnNames="head"
                             baseTableName="research_groups"
                             constraintName="fk_research_groups_head"
                             referencedColumnNames="user_id"
                             referencedTableName="users"/>

    <addForeignKeyConstraint baseColumnNames="user_id"
                             baseTableName="user_roles"
                             constraintName="fk_user_roles_user"
                             referencedColumnNames="user_id"
                             referencedTableName="users"/>

    <addForeignKeyConstraint baseColumnNames="research_group_id"
                             baseTableName="user_roles"
                             constraintName="fk_user_roles_research_group"
                             referencedColumnNames="research_group_id"
                             referencedTableName="research_groups"/>

    <addForeignKeyConstraint baseColumnNames="user_id"
                             baseTableName="user_login_providers"
                             constraintName="fk_user_login_providers_user"
                             referencedColumnNames="user_id"
                             referencedTableName="users"/>

    <addPrimaryKey columnNames="user_id, role" constraintName="pk_user_roles"
                   tableName="user_roles"/>

    <addPrimaryKey columnNames="user_id, login_provider" constraintName="pk_user_login_providers"
                   tableName="user_login_providers"/>
  </changeSet>
</databaseChangeLog>
