<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

  <changeSet id="001_create_users" author="marc-fett">
    <createTable tableName="users">
      <column name="user_id" type="CHAR(36)">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="research_group_id" type="CHAR(36)"/>
      <column name="email" type="TEXT">
        <constraints nullable="false"/>
      </column>
      <column name="avatar_file_id" type="CHAR(36)"/>
      <column name="first_name" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="last_name" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="gender" type="VARCHAR(255)"/>
      <column name="nationality" type="VARCHAR(255)"/>
      <column name="phone_number" type="TEXT"/>
      <column name="website" type="TEXT"/>
      <column name="linkedin_url" type="TEXT"/>
      <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
        <constraints nullable="false"/>
      </column>
      <column name="last_modified_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <sql>
      ALTER TABLE users MODIFY last_modified_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE
        CURRENT_TIMESTAMP;
    </sql>
  </changeSet>

  <changeSet id="002_create_research_groups" author="marc-fett">
    <createTable tableName="research_groups">
      <column name="research_group_id" type="CHAR(36)">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="head" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="name" type="TEXT">
        <constraints nullable="false"/>
      </column>
      <column name="abbreviation" type="VARCHAR(255)"/>
      <column name="email" type="TEXT"/>
      <column name="website" type="TEXT"/>
      <column name="school" type="TEXT"/>
      <column name="description" type="LONGTEXT"/>
      <column name="default_field_of_studies" type="TEXT"/>
      <column name="street" type="TEXT"/>
      <column name="postal_code" type="VARCHAR(10)"/>
      <column name="city" type="TEXT"/>
      <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
        <constraints nullable="false"/>
      </column>
      <column name="last_modified_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="003_create_user_roles" author="marc-fett">
    <createTable tableName="user_research_group_roles">
      <column name="user_research_group_role_id" type="CHAR(36)">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="user_id" type="CHAR(36)">
        <constraints nullable="false"/>
      </column>
      <column name="research_group_id" type="CHAR(36)"/>
      <column name="role" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addUniqueConstraint
      tableName="user_research_group_roles"
      columnNames="user_id, research_group_id, role"
      constraintName="uc_user_group_role_unique"
    />
  </changeSet>

  <changeSet id="004_add_constraints" author="marc-fett">
    <addForeignKeyConstraint baseColumnNames="research_group_id"
                             baseTableName="users"
                             constraintName="fk_users_research_group"
                             referencedColumnNames="research_group_id"
                             referencedTableName="research_groups"/>

    <addForeignKeyConstraint baseColumnNames="user_id"
                             baseTableName="user_research_group_roles"
                             constraintName="fk_user_research_group_roles_user"
                             referencedColumnNames="user_id"
                             referencedTableName="users"/>

    <addForeignKeyConstraint baseColumnNames="research_group_id"
                             baseTableName="user_research_group_roles"
                             constraintName="fk_user_research_group_roles_research_group"
                             referencedColumnNames="research_group_id"
                             referencedTableName="research_groups"/>
  </changeSet>
</databaseChangeLog>
