<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

  <changeSet id="028_enforce_single_owner_in_document_dictionary" author="codex">
    <comment>
      Enforce that each document_dictionary row belongs to exactly one owner:
      applicant OR application OR custom_field_answer.
    </comment>

    <!-- Data cleanup for legacy invalid rows.
         Owner precedence for mixed rows:
         application > custom_field_answer > applicant -->
    <sql>
      UPDATE document_dictionary
      SET applicant_id = NULL
      WHERE application_id IS NOT NULL
        AND applicant_id IS NOT NULL;
    </sql>

    <sql>
      UPDATE document_dictionary
      SET custom_field_answer_id = NULL
      WHERE application_id IS NOT NULL
        AND custom_field_answer_id IS NOT NULL;
    </sql>

    <sql>
      UPDATE document_dictionary
      SET applicant_id = NULL
      WHERE custom_field_answer_id IS NOT NULL
        AND applicant_id IS NOT NULL
        AND application_id IS NULL;
    </sql>

    <!-- Remove orphaned rows without any owner to allow constraint creation -->
    <sql>
      DELETE FROM document_dictionary
      WHERE applicant_id IS NULL
        AND application_id IS NULL
        AND custom_field_answer_id IS NULL;
    </sql>

    <sql>
      ALTER TABLE document_dictionary
      ADD CONSTRAINT chk_document_dictionary_exactly_one_owner
      CHECK (
        (applicant_id IS NOT NULL AND application_id IS NULL AND custom_field_answer_id IS NULL)
        OR (applicant_id IS NULL AND application_id IS NOT NULL AND custom_field_answer_id IS NULL)
        OR (applicant_id IS NULL AND application_id IS NULL AND custom_field_answer_id IS NOT NULL)
      );
    </sql>

    <rollback>
      <sql>
        ALTER TABLE document_dictionary
        DROP CHECK chk_document_dictionary_exactly_one_owner;
      </sql>
    </rollback>
  </changeSet>

</databaseChangeLog>
