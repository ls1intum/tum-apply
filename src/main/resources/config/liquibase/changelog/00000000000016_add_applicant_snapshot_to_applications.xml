<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

  <changeSet id="016_add_applicant_snapshot_to_applications" author="system">
    <comment>
      Add applicant snapshot fields to applications table to preserve applicant information at time of submission.
      This decouples application data from the applicant profile, preventing retroactive changes.
    </comment>

    <!-- User-related snapshot fields -->
    <addColumn tableName="applications">
      <column name="applicant_first_name" type="VARCHAR(255)">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <addColumn tableName="applications">
      <column name="applicant_last_name" type="VARCHAR(255)">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <addColumn tableName="applications">
      <column name="applicant_email" type="TEXT">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <addColumn tableName="applications">
      <column name="applicant_gender" type="VARCHAR(255)">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <addColumn tableName="applications">
      <column name="applicant_nationality" type="VARCHAR(255)">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <addColumn tableName="applications">
      <column name="applicant_birthday" type="DATE">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <addColumn tableName="applications">
      <column name="applicant_phone_number" type="TEXT">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <addColumn tableName="applications">
      <column name="applicant_website" type="TEXT">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <addColumn tableName="applications">
      <column name="applicant_linkedin_url" type="TEXT">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <!-- Applicant address snapshot fields -->
    <addColumn tableName="applications">
      <column name="applicant_street" type="TEXT">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <addColumn tableName="applications">
      <column name="applicant_postal_code" type="VARCHAR(10)">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <addColumn tableName="applications">
      <column name="applicant_city" type="TEXT">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <addColumn tableName="applications">
      <column name="applicant_country" type="TEXT">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <!-- Bachelor degree snapshot fields -->
    <addColumn tableName="applications">
      <column name="applicant_bachelor_degree_name" type="TEXT">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <addColumn tableName="applications">
      <column name="applicant_bachelor_grade_upper_limit" type="VARCHAR(255)">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <addColumn tableName="applications">
      <column name="applicant_bachelor_grade_lower_limit" type="VARCHAR(255)">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <addColumn tableName="applications">
      <column name="applicant_bachelor_grade" type="VARCHAR(255)">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <addColumn tableName="applications">
      <column name="applicant_bachelor_university" type="TEXT">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <!-- Master degree snapshot fields -->
    <addColumn tableName="applications">
      <column name="applicant_master_degree_name" type="TEXT">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <addColumn tableName="applications">
      <column name="applicant_master_grade_upper_limit" type="VARCHAR(255)">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <addColumn tableName="applications">
      <column name="applicant_master_grade_lower_limit" type="VARCHAR(255)">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <addColumn tableName="applications">
      <column name="applicant_master_grade" type="VARCHAR(255)">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <addColumn tableName="applications">
      <column name="applicant_master_university" type="TEXT">
        <constraints nullable="true"/>
      </column>
    </addColumn>

    <!-- Data migration: Copy existing applicant data to snapshot fields for all existing applications -->
    <!-- MySQL-specific syntax -->
    <sql dbms="mysql">
      UPDATE applications a
      INNER JOIN applicants ap ON a.applicant_id = ap.user_id
      INNER JOIN users u ON ap.user_id = u.user_id
      SET
        a.applicant_first_name = u.first_name,
        a.applicant_last_name = u.last_name,
        a.applicant_email = u.email,
        a.applicant_gender = u.gender,
        a.applicant_nationality = u.nationality,
        a.applicant_birthday = u.birthday,
        a.applicant_phone_number = u.phone_number,
        a.applicant_website = u.website,
        a.applicant_linkedin_url = u.linkedin_url,
        a.applicant_street = ap.street,
        a.applicant_postal_code = ap.postal_code,
        a.applicant_city = ap.city,
        a.applicant_country = ap.country,
        a.applicant_bachelor_degree_name = ap.bachelor_degree_name,
        a.applicant_bachelor_grade_upper_limit = ap.bachelor_grade_upper_limit,
        a.applicant_bachelor_grade_lower_limit = ap.bachelor_grade_lower_limit,
        a.applicant_bachelor_grade = ap.bachelor_grade,
        a.applicant_bachelor_university = ap.bachelor_university,
        a.applicant_master_degree_name = ap.master_degree_name,
        a.applicant_master_grade_upper_limit = ap.master_grade_upper_limit,
        a.applicant_master_grade_lower_limit = ap.master_grade_lower_limit,
        a.applicant_master_grade = ap.master_grade,
        a.applicant_master_university = ap.master_university;
    </sql>

    <!-- H2-specific syntax for tests -->
    <sql dbms="h2">
      UPDATE applications a
      SET (
        applicant_first_name,
        applicant_last_name,
        applicant_email,
        applicant_gender,
        applicant_nationality,
        applicant_birthday,
        applicant_phone_number,
        applicant_website,
        applicant_linkedin_url,
        applicant_street,
        applicant_postal_code,
        applicant_city,
        applicant_country,
        applicant_bachelor_degree_name,
        applicant_bachelor_grade_upper_limit,
        applicant_bachelor_grade_lower_limit,
        applicant_bachelor_grade,
        applicant_bachelor_university,
        applicant_master_degree_name,
        applicant_master_grade_upper_limit,
        applicant_master_grade_lower_limit,
        applicant_master_grade,
        applicant_master_university
      ) = (
        SELECT
          u.first_name,
          u.last_name,
          u.email,
          u.gender,
          u.nationality,
          u.birthday,
          u.phone_number,
          u.website,
          u.linkedin_url,
          ap.street,
          ap.postal_code,
          ap.city,
          ap.country,
          ap.bachelor_degree_name,
          ap.bachelor_grade_upper_limit,
          ap.bachelor_grade_lower_limit,
          ap.bachelor_grade,
          ap.bachelor_university,
          ap.master_degree_name,
          ap.master_grade_upper_limit,
          ap.master_grade_lower_limit,
          ap.master_grade,
          ap.master_university
        FROM applicants ap
        INNER JOIN users u ON ap.user_id = u.user_id
        WHERE ap.user_id = a.applicant_id
      );
    </sql>

  </changeSet>

</databaseChangeLog>
