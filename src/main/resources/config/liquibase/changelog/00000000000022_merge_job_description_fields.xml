<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

  <changeSet id="22-merge-job-description-fields" author="melissa">
    <addColumn tableName="jobs">
      <column name="job_description" type="TEXT"/>
    </addColumn>

    <sql dbms="mysql">
      UPDATE jobs
      SET job_description =
            CONCAT(
              COALESCE(description, ''),
              CASE
                WHEN description IS NOT NULL AND description &lt;&gt; ''
                  AND ((tasks IS NOT NULL AND tasks &lt;&gt; '') OR
                       (requirements IS NOT NULL AND requirements &lt;&gt; ''))
                  THEN '\n\n'
                ELSE '' END,
              COALESCE(tasks, ''),
              CASE
                WHEN tasks IS NOT NULL AND tasks &lt;&gt; '' AND requirements IS NOT NULL AND requirements &lt;&gt; ''
                  THEN '\n\n'
                ELSE '' END,
              COALESCE(requirements, '')
            )
      WHERE description IS NOT NULL
         OR tasks IS NOT NULL
         OR requirements IS NOT NULL;
    </sql>

    <dropColumn tableName="jobs" columnName="description"/>
    <dropColumn tableName="jobs" columnName="tasks"/>
    <dropColumn tableName="jobs" columnName="requirements"/>
  </changeSet>

</databaseChangeLog>
