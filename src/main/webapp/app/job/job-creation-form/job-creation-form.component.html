<jhi-confirm-dialog
  #sendPublishDialog
  class="confirm-dialog"
  [header]="'jobCreationForm.confirmDialog.header' | translate"
  [message]="'jobCreationForm.confirmDialog.message' | translate"
  [label]="'button.publish' | translate"
  [severity]="publishButtonSeverity"
  [confirmIcon]="publishButtonIcon"
  [showOpenButton]="false"
  (confirmed)="publishJob()"
  [dialogStyleClass]="'confirm-dialog-lg'"
/>
@if (!isLoading()) {
  <div class="page-container">
    <div class="page-header">
      <h1 jhiTranslate="{{ pageTitle() }}"></h1>
    </div>
    <div>
      <jhi-progress-stepper [steps]="stepData()" [shouldTranslate]="true" />
    </div>
  </div>

  <!-- Step 1: Basic Information -->
  <ng-template #panel1>
    <div class="h-full items-center justify-center flex px-4 xl:px-32 2xl:px-64">
      <form [formGroup]="basicInfoForm" class="w-full">
        <p jhiTranslate="jobCreationForm.basicInformationSection.description"></p>
        <p-divider layout="horizontal"><span jhiTranslate="jobCreationForm.header.basicInfo.section1"></span> </p-divider>
        <div class="flex flex-col">
          <div class="flex flex-col lg:flex-row lg:gap-8">
            <div class="flex-1">
              <jhi-string-input
                [label]="'jobCreationForm.basicInformationSection.jobTitle.label' | translate"
                [placeholder]="'jobCreationForm.basicInformationSection.jobTitle.placeholder' | translate"
                [required]="true"
                [model]="basicInfoForm.get('title')?.value"
                [control]="basicInfoForm.get('title') ?? undefined"
              />
            </div>
          </div>

          <div class="flex flex-col lg:flex-row lg:gap-8">
            <div class="flex-1">
              <jhi-string-input
                [label]="'jobCreationForm.basicInformationSection.researchArea.label' | translate"
                [placeholder]="'jobCreationForm.basicInformationSection.researchArea.placeholder' | translate"
                [required]="true"
                icon="circle-info"
                [model]="basicInfoForm.get('researchArea')?.value"
                [control]="basicInfoForm.get('researchArea') ?? undefined"
                [tooltipText]="'jobCreationForm.basicInformationSection.researchArea.toolTipText' | translate"
              />
            </div>

            <div class="flex-1">
              <jhi-select
                [selected]="basicInfoForm.get('fieldOfStudies')?.value"
                (selectedChange)="basicInfoForm.get('fieldOfStudies')?.setValue($event)"
                [items]="translatedFieldsOfStudies()"
                [label]="'jobCreationForm.basicInformationSection.fieldOfStudies.label' | translate"
                [placeholder]="'jobCreationForm.basicInformationSection.fieldOfStudies.placeholder' | translate"
                [required]="true"
                [width]="'100%'"
                [filter]="true"
                [dataKey]="'value'"
                [errorEnabled]="true"
              />
            </div>
          </div>

          <div class="flex flex-col lg:flex-row lg:gap-8">
            <div class="flex-1 input-with-icon">
              <label for="supervisingProfessor" jhiTranslate="jobCreationForm.basicInformationSection.supervisingProfessor.label">
                <span class="required">*</span>
              </label>
              <div class="icon-input-wrapper">
                <fa-icon [icon]="['fas', 'user-tie']" class="input-icon" />
                <input
                  [disabled]="true"
                  [value]="basicInfoForm.get('supervisingProfessor')?.value"
                  id="supervisingProfessor"
                  type="text"
                  class="w-full px-3 py-2 border border-border-default rounded-md text-base focus:outline-none focus:border-primary disabled:text-text-disabled disabled:bg-background-disabled"
                />
              </div>
              <div class="error-text"></div>
            </div>

            <div class="flex-1">
              <jhi-select
                [selected]="basicInfoForm.get('location')?.value"
                (selectedChange)="basicInfoForm.get('location')?.setValue($event)"
                [items]="translatedLocations()"
                [label]="'jobCreationForm.basicInformationSection.location.label' | translate"
                [placeholder]="'jobCreationForm.basicInformationSection.location.placeholder' | translate"
                [required]="true"
                [width]="'100%'"
                [filter]="true"
                [dataKey]="'value'"
                [errorEnabled]="true"
              />
            </div>
          </div>
        </div>

        <p-divider layout="horizontal"><span jhiTranslate="jobCreationForm.header.basicInfo.section2"></span> </p-divider>
        <p jhiTranslate="jobCreationForm.positionDetailsSection.description"></p>
        <p jhiTranslate="jobCreationForm.positionDetailsSection.languageInfo"></p>

        <!-- Header row: Language switcher (left) + AI toggle (right) -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mt-3 mb-3">
          <div class="flex items-center gap-3">
            <jhi-segmented-toggle
              [value]="segmentValueForLang(currentDescriptionLanguage())"
              [disabled]="isTranslating() || isGeneratingDraft() || savingState() === 'SAVING'"
              [leftLabel]="'jobCreationForm.positionDetailsSection.jobDescription.languageEnglish'"
              [rightLabel]="'jobCreationForm.positionDetailsSection.jobDescription.languageGerman'"
              [translateLabels]="true"
              (valueChange)="changeDescriptionLanguage(langForSegmentValue($event))"
            />

            <!-- Translation indicator -->
            @if (isTranslating()) {
              <div class="flex items-center gap-2 px-3 h-8 border border-border-default rounded-lg">
                <jhi-progress-spinner styleClass="w-4 h-4" strokeWidth="4" />
                <span
                  class="text-sm font-semibold text-text-primary whitespace-nowrap"
                  jhiTranslate="jobCreationForm.positionDetailsSection.jobDescription.translating"
                ></span>
              </div>
            }
          </div>

          <div class="flex items-center gap-2 sm:justify-end">
            <jhi-toggle-switch [(model)]="aiToggleSignal" class="flex" />
            <label class="text-sm whitespace-nowrap" jhiTranslate="jobCreationForm.positionDetailsSection.jobDescription.aiToggle"></label>
          </div>
        </div>

        <div class="flex flex-col gap-2 mb-6">
          <div class="grid gap-4 items-start" [class.lg:grid-cols-[1fr_auto_220px]]="showAiPanel()">
            <!-- Editor -->
            <div>
              <jhi-editor
                #jobDescriptionEditor
                fieldId="jobDescription"
                label="jobCreationForm.positionDetailsSection.jobDescription.label"
                [placeholder]="jobDescriptionPlaceholder()"
                helperText="jobCreationForm.positionDetailsSection.jobDescription.descriptionHelper"
                tooltipText="jobCreationForm.positionDetailsSection.jobDescription.toolTipText"
                [required]="true"
                [characterLimit]="1500"
                [model]="jobDescriptionSignal()"
                [control]="basicInfoForm.get('jobDescription') ?? undefined"
                icon="circle-info"
                [shouldTranslate]="true"
                [showGenderDecoderButton]="true"
              />
            </div>

            @if (showAiPanel()) {
              <!-- Divider -->
              <p-divider layout="vertical" styleClass="mx-2 hidden lg:block" />

              <!-- AI Panel -->
              <!-- span full width when stacked (small screens), keep constrained on lg+ -->
              <div class="mt-0 w-full lg:max-w-[200px] col-span-full lg:col-auto text-center flex flex-col items-center">
                <h3
                  class="mb-3 font-bold text-center"
                  jhiTranslate="jobCreationForm.positionDetailsSection.jobDescription.aiHeaderText"
                ></h3>
                <h4
                  class="whitespace-pre-line mb-4 text-base text-center"
                  jhiTranslate="jobCreationForm.positionDetailsSection.jobDescription.aiHelperText"
                ></h4>

                <div class="flex justify-center">
                  @if (isGeneratingDraft()) {
                    <div class="flex items-center gap-2 px-3 h-8 border border-border-default rounded-lg">
                      <jhi-progress-spinner styleClass="w-4 h-4" strokeWidth="4" />
                      <span
                        class="text-sm font-semibold text-text-primary whitespace-nowrap"
                        jhiTranslate="jobCreationForm.positionDetailsSection.jobDescription.aiFillerText"
                      ></span>
                    </div>
                  } @else {
                    <div class="w-full flex justify-center">
                      <jhi-button
                        type="button"
                        [label]="
                          rewriteButtonSignal()
                            ? 'jobCreationForm.positionDetailsSection.jobDescription.aiButton2'
                            : 'jobCreationForm.positionDetailsSection.jobDescription.aiButton1'
                        "
                        [shouldTranslate]="true"
                        severity="primary"
                        class="w-full lg:w-auto min-w-0 lg:min-w-[160px]"
                        (click)="generateJobApplicationDraft()"
                      />
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      </form>
    </div>
  </ng-template>

  <!-- Step 2: Employment Terms -->
  <ng-template #panel2>
    <div class="h-full min-h-[calc(100vh-300px)] flex flex-column px-4 xl:px-32 2xl:px-64">
      <form [formGroup]="positionDetailsForm" class="w-full">
        <p-divider layout="horizontal"><span jhiTranslate="jobCreationForm.header.basicInfo.section2"></span> </p-divider>
        <div class="flex flex-col">
          <div class="flex flex-col lg:flex-row lg:gap-8">
            <div class="flex-1">
              <jhi-datepicker
                [selectedDate]="positionDetailsForm.get('applicationDeadline')?.value"
                (selectedDateChange)="positionDetailsForm.get('applicationDeadline')?.setValue($event)"
                [label]="'jobCreationForm.basicInformationSection.applicationDeadline.label'"
                [placeholder]="'jobCreationForm.basicInformationSection.applicationDeadline.placeholder'"
                icon="circle-info"
                tooltipText="jobCreationForm.basicInformationSection.applicationDeadline.toolTipText"
                [shouldTranslate]="true"
                [width]="'100%'"
                [errorEnabled]="true"
              />
            </div>
            <div class="flex-1">
              <jhi-datepicker
                [selectedDate]="positionDetailsForm.get('startDate')?.value"
                (selectedDateChange)="positionDetailsForm.get('startDate')?.setValue($event)"
                [label]="'jobCreationForm.basicInformationSection.startDate.label'"
                [placeholder]="'jobCreationForm.basicInformationSection.startDate.placeholder'"
                icon="circle-info"
                tooltipText="jobCreationForm.basicInformationSection.startDate.toolTipText"
                [shouldTranslate]="true"
                [width]="'100%'"
                [errorEnabled]="true"
              />
            </div>
          </div>

          <div class="flex flex-col lg:flex-row lg:gap-8">
            <div class="flex-1">
              <jhi-number-input
                [label]="'jobCreationForm.basicInformationSection.workload.label' | translate"
                [placeholder]="'jobCreationForm.basicInformationSection.workload.placeholder' | translate"
                [model]="positionDetailsForm.get('workload')?.value"
                [control]="positionDetailsForm.get('workload') ?? undefined"
                [min]="1"
                [max]="40"
                [minFractionDigits]="0"
                [maxFractionDigits]="0"
                icon="circle-info"
                [tooltipText]="'jobCreationForm.basicInformationSection.workload.toolTipText' | translate"
              />
            </div>
            <div class="flex-1">
              <jhi-number-input
                [label]="'jobCreationForm.basicInformationSection.contractDuration.label' | translate"
                [placeholder]="'jobCreationForm.basicInformationSection.contractDuration.placeholder' | translate"
                [model]="positionDetailsForm.get('contractDuration')?.value"
                [control]="positionDetailsForm.get('contractDuration') ?? undefined"
                [min]="1"
                [max]="6"
                [minFractionDigits]="0"
                [maxFractionDigits]="2"
                icon="circle-info"
                [tooltipText]="'jobCreationForm.basicInformationSection.contractDuration.toolTipText' | translate"
              />
            </div>
          </div>

          <div class="flex flex-col lg:flex-row lg:gap-8">
            <div class="flex-1">
              <jhi-select
                [selected]="positionDetailsForm.get('fundingType')?.value"
                (selectedChange)="positionDetailsForm.get('fundingType')?.setValue($event)"
                [items]="translatedFundingTypes()"
                [label]="'jobCreationForm.basicInformationSection.fundingType.label' | translate"
                [placeholder]="'jobCreationForm.basicInformationSection.fundingType.placeholder' | translate"
                [width]="'100%'"
                [filter]="true"
                [showClear]="true"
                [dataKey]="'value'"
              />
            </div>
          </div>
        </div>
      </form>
    </div>
  </ng-template>

  <!-- Reusable Image Card Template -->
  <ng-template #imageCard let-image="image" let-showDelete="showDelete" let-isNoImage="isNoImage" let-isSelected="isSelected">
    <div
      [class]="'relative rounded-lg transition-all cursor-pointer hover:shadow-lg hover:-translate-y-1' + (showDelete ? ' group' : '')"
      (click)="isNoImage ? clearImageSelection() : selectImage(image)"
    >
      <div
        class="relative rounded-lg overflow-hidden border-[0.2rem] transition-colors aspect-video"
        [style.border-color]="isSelected ? 'var(--p-primary-color)' : 'transparent'"
      >
        @if (isNoImage) {
          <div class="w-full h-full flex flex-col items-center justify-center bg-background-surface-alt">
            <fa-icon [icon]="['fas', 'image']" [size]="'3x'" class="text-text-secondary" />
            <span class="text-sm text-text-secondary" jhiTranslate="jobCreationForm.imageSection.noImage"></span>
          </div>
        } @else {
          <img [src]="image.url" class="w-full h-full object-cover" />
        }
        @if (isSelected) {
          <div class="absolute inset-0 flex items-center justify-center bg-background-surface/50">
            <fa-icon [icon]="['fas', 'check']" [size]="'2x'" class="text-primary" />
          </div>
        }
      </div>
      @if (showDelete) {
        <div class="absolute top-2 right-2" (click)="$event.stopPropagation()">
          <jhi-confirm-dialog
            #deleteDialog
            [label]="'button.delete' | translate"
            [confirmIcon]="'trash'"
            [header]="'jobCreationForm.imageSection.deleteImageDialog.header' | translate"
            [message]="'jobCreationForm.imageSection.deleteImageDialog.message' | translate"
            [data]="image.imageId"
            (confirmed)="deleteImage($any($event))"
            severity="danger"
            [showOpenButton]="false"
          />
          <jhi-button icon="trash" size="sm" [severity]="'danger'" (click)="deleteDialog.confirm()" />
        </div>
      }
    </div>
  </ng-template>

  <!-- Step 3: Image Selection/Upload -->
  <ng-template #panel3>
    <div class="h-full items-center justify-center flex px-4 xl:px-32 2xl:px-64">
      <div class="w-full">
        <p class="mb-4" jhiTranslate="jobCreationForm.imageSection.description"></p>

        <!-- Default Image Section -->
        <div class="mb-4">
          <h3 class="text-lg font-semibold mb-2" jhiTranslate="jobCreationForm.imageSection.defaultImages"></h3>
          @if (defaultImages().length === 0) {
            <div class="mb-4">
              <jhi-info-box [message]="'jobCreationForm.imageSection.noDefaultImages' | translate" />
            </div>
          }
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-4 gap-4">
            <!-- No Image Option -->
            <ng-container
              *ngTemplateOutlet="
                imageCard;
                context: { image: null, showDelete: false, isNoImage: true, isSelected: selectedImage() === undefined }
              "
            />

            <!-- Default Images -->
            @for (image of defaultImages(); track image.imageId) {
              <ng-container
                *ngTemplateOutlet="
                  imageCard;
                  context: { image: image, showDelete: false, isNoImage: false, isSelected: selectedImage()?.imageId === image.imageId }
                "
              />
            }
          </div>
        </div>

        <p-divider layout="horizontal"><span jhiTranslate="jobCreationForm.imageSection.orDivider"></span></p-divider>

        <!-- Research Group Image Section -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold mb-2" jhiTranslate="jobCreationForm.imageSection.researchGroupImages"></h3>
          <p class="text-text-secondary mb-4" jhiTranslate="jobCreationForm.imageSection.researchGroupImagesDescription"></p>

          <!-- Grid of research group images + upload button -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-4 gap-4">
            @for (image of researchGroupImages(); track image.imageId) {
              <ng-container
                *ngTemplateOutlet="
                  imageCard;
                  context: { image: image, showDelete: true, isNoImage: false, isSelected: selectedImage()?.imageId === image.imageId }
                "
              />
            }

            <!-- Upload New Image Button -->
            <div [class]="uploadContainerClasses()" (click)="fileInput.click()">
              <input type="file" [accept]="acceptedImageTypes" (change)="onImageSelected($event)" #fileInput class="hidden" />
              <div [class]="uploadInnerClasses()">
                @if (isUploadingImage()) {
                  <jhi-progress-spinner styleClass="w-12 h-12" strokeWidth="4" />
                } @else {
                  <fa-icon [icon]="['fas', 'plus']" [size]="'3x'" class="text-primary" />
                }
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-template>

  <!-- Step 4: Review Page (formerly panel4, now actually panel4 but step 4) -->
  <ng-template #panel4>
    <jhi-message severity="warn" styleClass="mb-3" message="jobCreationForm.reviewPageSection.message" [shouldTranslate]="true" />
    <jhi-job-detail [previewData]="currentJobData" [isSummaryPage]="true" class="w-full" />
    <div class="data-privacy-notice">
      <p [innerHTML]="'jobCreationForm.additionalInformationSection.dataPrivacyText' | translate"></p>
    </div>
    <div [formGroup]="additionalInfoForm">
      <div class="flex align-items-start">
        <div class="relative mr-2">
          <p-checkbox formControlName="privacyAccepted" [binary]="true" size="small" />
          <span class="required">*</span>
        </div>
        <label jhiTranslate="jobCreationForm.additionalInformationSection.dataPrivacyConfirmationText"></label>
      </div>

      @if (privacyAcceptedSignal() === false && publishAttempted()) {
        <div class="error-text" jhiTranslate="jobCreationForm.additionalInformationSection.dataPrivacyErrorText"></div>
      }
    </div>
  </ng-template>

  <!-- Saving State Panel -->
  <ng-template #savingStatePanel>
    <div [className]="savingBadgeCalculatedClass()">
      <fa-icon [icon]="['fas', 'save']" />
      <span class="font-bold ml-2">
        {{ 'entity.applicationSteps.status.' + savingState() | translate }}
      </span>
    </div>
  </ng-template>
}
