<div class="filter-multiselect" [class.open]="isOpen()">
  <div
    class="filter-button"
    role="button"
    tabindex="0"
    [attr.aria-expanded]="isOpen()"
    aria-haspopup="listbox"
    (click)="toggleDropdown()"
    (keydown)="onTriggerKeydown($event)"
  >
    <div class="filter-trigger">
      @if (selectedOptions().length === 0) {
        <span class="trigger-placeholder">{{ filterLabel() | translate }}</span>
      } @else {
        @if (showSelectedChipsInTrigger() && selectedOptions().length <= maxVisibleChips) {
          <div class="chip-row">
            @for (option of selectedOptions(); track option.value) {
              <p-chip
                [label]="shouldTranslateOptions() ? (option.label | translate) : option.label"
                [removable]="true"
                (onRemove)="removeOption(option.value); $event.stopPropagation()"
                (click)="$event.stopPropagation()"
                [pt]="{ root: { class: 'compact-chip' } }"
              />
            }
          </div>
        } @else {
          <span class="trigger-summary">{{ getSummaryLabel() }}</span>
        }
      }
    </div>
    <fa-icon class="filter-icon" [icon]="['fas', 'chevron-down']" [ngClass]="{ rotated: isOpen() }" />
  </div>

  @if (isOpen()) {
    <div class="filter-dropdown" [class.align-right]="dropdownAlignment() === 'right'">
      <div class="panel-header">
        <fa-icon class="filter-icon text-primary" [icon]="['fas', 'search']" />
        <input
          type="text"
          class="search-input"
          [placeholder]="filterSearchPlaceholder() | translate"
          [value]="searchTerm()"
          (input)="onSearchChange($event)"
        />
      </div>

      <!-- Divider between search bar and listed options -->
      <p-divider />

      <div class="options-container">
        <div class="options-list">
          <!-- List all selected options -->
          @if (hasSelectedItems()) {
            <p-divider>
              <div class="divider-content">
                <span class="divider-text"> {{ 'entity.filters.selected' | translate }} ({{ selectedOptions().length }}) </span>
                <button type="button" class="divider-text clear-button" (click)="clearAll(); $event.stopPropagation()">
                  {{ 'entity.filters.clearAll' | translate }}
                </button>
              </div>
            </p-divider>
            @for (option of selectedOptions(); track option.value; let i = $index) {
              <div class="option-item selected" (click)="toggleOption(option.value)">
                <p-checkbox [binary]="true" [ngModel]="true" [disabled]="true" />
                <span class="option-label">
                  @if (shouldTranslateOptions()) {
                    {{ option.label | translate }}
                  } @else {
                    {{ option.label }}
                  }
                </span>
              </div>
            }
          }

          <!-- Divider between selected and unselected options -->
          @if (hasSelectedItems() && hasUnselectedItems()) {
            <p-divider />
          }

          <!-- List all unselected options -->
          @if (hasUnselectedItems()) {
            @for (option of unselectedOptions(); track option.value; let i = $index) {
              <div class="option-item" (click)="toggleOption(option.value)" [class.focused]="focusedIndexOptionList() === i">
                <p-checkbox [binary]="true" [ngModel]="false" [disabled]="true" />
                <span class="option-label">
                  @if (shouldTranslateOptions()) {
                    {{ option.label | translate }}
                  } @else {
                    {{ option.label }}
                  }
                </span>
              </div>
            }
          }

          <!-- Display that no results were found-->
          @if (filteredOptions().length === 0) {
            <div class="no-results">
              <span>{{ 'entity.filters.noResults' | translate }}</span>
            </div>
          }
        </div>
      </div>
    </div>
  }

  @if (!showSelectedChipsInTrigger() && selectedOptions().length > 0) {
    <div class="selected-chips-list">
      @for (option of selectedOptions(); track option.value) {
        <p-chip
          [label]="shouldTranslateOptions() ? (option.label | translate) : option.label"
          [removable]="true"
          (onRemove)="removeOption(option.value)"
          [pt]="{ root: { class: 'compact-chip' } }"
        />
      }
    </div>
  }
</div>
