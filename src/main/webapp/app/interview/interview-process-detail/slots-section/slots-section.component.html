<!-- Loading State -->
@if (loading()) {
  <div class="flex justify-center items-center py-8">
    <p-progressSpinner styleClass="w-12 h-12" />
  </div>
}

<!-- Error State -->
@if (error() && !loading()) {
  <div class="flex justify-center items-center py-8">
    <div class="flex flex-col items-center gap-4 text-center max-w-md mx-auto">
      <fa-icon icon="exclamation-triangle" class="text-4xl text-negative-default" />
      <h3 class="text-xl font-semibold" jhiTranslate="interview.detail.error.title">Failed to load slots</h3>
      <p class="text-secondary-default" jhiTranslate="interview.detail.error.description">
        There was an error loading the interview slots. Please try again.
      </p>
      <jhi-button [label]="'interview.detail.error.retry'" [shouldTranslate]="true" [icon]="'rotate-right'" (click)="refreshSlots()" />
    </div>
  </div>
}

@if (!loading() && !error()) {
  @if (hasAnySlots() === false) {
    <!-- Global Empty State (No slots at all) -->
    <div class="flex justify-center items-center py-12">
      <div class="flex flex-col items-center gap-4 text-center max-w-md mx-auto">
        <fa-icon icon="calendar-xmark" class="text-4xl text-text-tertiary" />
        <h3 class="text-xl font-semibold" jhiTranslate="interview.detail.empty.title">No slots yet</h3>
        <p class="text-text-secondary" jhiTranslate="interview.detail.empty.description">
          Create your first interview slots to get started.
        </p>
        @if (!isClosed()) {
          <jhi-button [label]="'interview.slots.addSlots'" [shouldTranslate]="true" [icon]="'plus'" (click)="openCreateSlotsModal()" />
        }
      </div>
    </div>
  } @else {
    <div>
      <!-- Month Navigation -->
      <jhi-month-navigation
        [currentMonth]="currentMonth()"
        [isClosed]="isClosed()"
        (previousMonth)="previousMonth()"
        (nextMonth)="nextMonth()"
        (addSlots)="openCreateSlotsModal()"
      />
      @if (groupedSlots().length > 0) {
        <div [class]="datesPerPage() === 1 ? 'flex flex-col gap-4' : 'flex items-start gap-4'">
          <!-- Left Pagination Arrow (Desktop) -->
          @if (datesPerPage() > 1) {
            <div class="flex-shrink-0 pt-8">
              <jhi-button [icon]="'chevron-left'" [variant]="'text'" [disabled]="!canGoPreviousDate()" (click)="previousDatePage()" />
            </div>
          }

          <!-- Date Grid (visible dates depend on screen size) -->
          <div class="flex-1 min-w-0 overflow-hidden" [class.w-full]="datesPerPage() === 1">
            <div class="grid gap-3" [style.grid-template-columns]="'repeat(' + datesPerPage() + ', 1fr)'">
              @for (group of paginatedSlots(); track group.date) {
                <div class="flex flex-col gap-2">
                  <!-- Date Header -->
                  <jhi-date-header [date]="group.localDate" [slotCount]="group.slots.length" />

                  <!-- Slot Cards -->
                  <div class="flex flex-col gap-2">
                    @for (slot of getVisibleSlots(group.date, group.slots); track slot.id) {
                      <jhi-slot-card
                        [slot]="slot"
                        [isClosed]="isClosed()"
                        (editSlot)="onEditSlot()"
                        (deleteSlot)="onDeleteSlot(slot)"
                        (assignApplicant)="onAssignApplicant(slot)"
                      />
                    }

                    <!-- Show More/Less Button -->
                    @if (group.slots.length > 3) {
                      <jhi-button
                        class="w-full"
                        [fullWidth]="true"
                        [variant]="'text'"
                        [icon]="isExpanded(group.date) ? 'chevron-up' : 'chevron-down'"
                        [label]="
                          isExpanded(group.date)
                            ? 'interview.detail.showLess'
                            : getShowMoreText(getRemainingCount(group.date, group.slots.length))
                        "
                        [shouldTranslate]="isExpanded(group.date)"
                        [styleClass]="'w-full py-2 border border-border-default rounded-md text-text-secondary text-sm font-medium flex items-center justify-center gap-1.5 hover:bg-background-surface hover:border-border-default transition-all'"
                        (click)="toggleExpanded(group.date)"
                      />
                    }
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Right Pagination Arrow (Desktop) -->
          @if (datesPerPage() > 1) {
            <div class="flex-shrink-0 pt-8">
              <jhi-button [icon]="'chevron-right'" [variant]="'text'" [disabled]="!canGoNextDate()" (click)="nextDatePage()" />
            </div>
          }

          <!-- Mobile Pagination (Bottom) -->
          @if (datesPerPage() === 1) {
            <div class="flex justify-center items-center w-full pt-4 gap-6">
              <jhi-button
                [icon]="'chevron-left'"
                [variant]="'text'"
                [size]="'sm'"
                [disabled]="!canGoPreviousDate()"
                (click)="previousDatePage()"
              />
              <span class="text-sm font-medium text-text-secondary min-w-[3rem] text-center">
                {{ currentDatePage() + 1 }} / {{ totalDatePages() }}
              </span>
              <jhi-button
                [icon]="'chevron-right'"
                [variant]="'text'"
                [size]="'sm'"
                [disabled]="!canGoNextDate()"
                (click)="nextDatePage()"
              />
            </div>
          }
        </div>
      } @else {
        <!-- No slots in current month (but slots exist elsewhere) -->
        <div class="text-center py-12 text-text-secondary">
          <fa-icon icon="calendar-xmark" class="text-5xl mb-4 block" />
          <p class="text-lg" [jhiTranslate]="'interview.detail.noSlotsInMonth'" [translateValues]="{ month: currentMonth() }">
            No slots in {{ currentMonth() }}
          </p>
        </div>
      }
    </div>
  }
}

<jhi-slot-creation-form [(visible)]="showSlotCreationForm" [processId]="processId()" (success)="onSlotsCreated()" />

@if (selectedSlotForAssignment()) {
  <jhi-assign-applicant-modal
    [visible]="showAssignModal()"
    [slot]="selectedSlotForAssignment()!"
    [processId]="processId()"
    [refreshKey]="refreshKey()"
    (visibleChange)="showAssignModal.set($event)"
    (applicantAssigned)="onApplicantAssigned()"
  />
}
