<div class="rounded-lg border border-border-default bg-background-default mb-4">
  <!-- Header -->
  <div class="flex w-full items-center justify-between p-3 border-border-default" [class.border-b]="!isCollapsed()">
    <!-- Left: Toggle + Date -->
    <div class="flex items-center gap-3">
      <jhi-button
        [icon]="isCollapsed() ? 'chevron-down' : 'chevron-up'"
        variant="text"
        severity="secondary"
        size="xs"
        styleClass="text-text-secondary"
        (click)="toggleCollapse()"
      />

      <div class="flex flex-col">
        <span class="text-xs font-semibold text-text-secondary">
          {{ date() | date: 'EEE' | uppercase }}
        </span>
        <span class="text-base font-bold text-text-primary">
          {{ date() | date: 'mediumDate' }}
        </span>
      </div>
    </div>

    <!-- Right: Slot type Buttons + Delete Date -->
    <div class="flex gap-2 items-center">
      <jhi-button
        [label]="'interview.slots.create.addSlot'"
        [shouldTranslate]="true"
        variant="outlined"
        size="xs"
        icon="plus"
        [pTooltip]="'interview.slots.create.addSlotsTooltip' | translate"
        tooltipPosition="top"
        severity="primary"
        styleClass="text-[var(--p-secondary-400)] border-[var(--p-accent-500)]"
        (click)="addSingleSlot()"
      />

      <jhi-button
        [label]="'interview.slots.create.addRange'"
        [shouldTranslate]="true"
        variant="outlined"
        size="xs"
        icon="plus"
        [pTooltip]="'interview.slots.create.addRangeTooltip' | translate"
        tooltipPosition="top"
        severity="primary"
        styleClass="text-[var(--p-secondary-600)]"
        (click)="addRange()"
      />

      <p-divider layout="vertical" styleClass="h-6 m-0 mx-1" />

      <jhi-button icon="trash" variant="text" severity="danger" size="xs" (click)="remove.emit()" />
    </div>
  </div>

  <!-- Card Content -->
  @if (!isCollapsed()) {
    <div class="p-3">
      <div class="flex flex-col gap-2">
        @if (slotRanges().length === 0) {
          <div class="flex flex-col items-center justify-center py-8 text-secondary">
            <span class="text-s">
              {{ 'interview.slots.create.noSlotsYet' | translate }}
            </span>
            <span class="text-xs">
              {{ 'interview.slots.create.noSlotsYetDesc' | translate }}
            </span>
          </div>
        } @else {
          @for (range of slotRanges(); track range.id; let rangeIndex = $index) {
            @if (rangeIndex > 0) {
              <div class="w-full h-px bg-border-default my-2"></div>
            }
            <div class="flex gap-2">
              <!-- Colored Bar Left -->
              <div
                [class]="
                  'w-1 flex-shrink-0 self-stretch rounded-full ' +
                  (range.type === 'single' ? 'bg-[var(--p-secondary-400)]' : 'bg-[var(--p-secondary-600)]')
                "
              ></div>
              <div class="flex flex-1 flex-col gap-0.5">
                <!-- Slot Row Header -->
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="text-sm font-semibold text-text-primary">
                      @switch (range.type) {
                        @case ('single') {
                          {{ 'interview.slots.create.singleSlot' | translate }}
                        }
                        @case ('range') {
                          {{ 'interview.slots.create.rangeSlot' | translate }}
                        }
                      }
                    </span>
                    <fa-icon
                      [icon]="['fas', 'circle-info']"
                      class="text-primary text-xs"
                      [pTooltip]="
                        (range.type === 'single' ? 'interview.slots.create.singleSlotHelp' : 'interview.slots.create.rangeSlotHelp')
                          | translate
                      "
                      tooltipPosition="top"
                      tooltipStyleClass="max-w-xs"
                    />
                  </div>

                  <jhi-button severity="danger" variant="text" icon="trash" size="xs" (click)="removeRange(rangeIndex)" />
                </div>

                @if (range.type !== 'scheduled') {
                  <div
                    class="flex flex-col gap-1 rounded-md pt-1 pb-2 px-2"
                    [class.border]="range.type === 'single' && allConflicts().has(range.id + '_0')"
                    [class.border-negative-default]="range.type === 'single' && allConflicts().has(range.id + '_0')"
                  >
                    <!-- Time Inputs-->
                    <div class="flex gap-4 mb-3">
                      <!-- START TIME -->
                      <div class="flex flex-col gap-1">
                        <label [for]="'start-' + range.id" class="text-xs text-text-primary">
                          {{ 'interview.slots.create.startTime' | translate }}
                        </label>
                        <jhi-time-input
                          [id]="'start-' + range.id"
                          [value]="range.startTimeString || ''"
                          (valueChange)="onStartInput(rangeIndex, $event)"
                        />
                      </div>

                      <!-- END TIME -->
                      @if (range.type === 'range' || (range.type === 'single' && range.startTimeString)) {
                        <div class="flex flex-col gap-1">
                          <label [for]="'end-' + range.id" class="text-xs text-text-primary">
                            {{ 'interview.slots.create.endTime' | translate }}
                          </label>
                          <jhi-time-input
                            [id]="'end-' + range.id"
                            [value]="range.endTimeString || ''"
                            (valueChange)="onEndInput(rangeIndex, $event)"
                            [disabled]="range.type === 'single'"
                          />
                        </div>
                      } @else {
                        <div class="flex-1"></div>
                      }
                    </div>

                    <!-- Location Input -->
                    <div class="flex flex-col gap-1">
                      <label [for]="'location-' + range.id" class="text-xs text-text-primary">
                        {{ 'interview.slots.create.location' | translate }}
                      </label>
                      <div class="flex items-end">
                        <jhi-string-input
                          [class]="
                            'flex-1 [&_.custom-input]:h-8 [&_.custom-input]:w-full [&_.custom-input]:text-xs [&_.custom-input]:font-normal [&_.label-with-tooltip]:mb-2 block' +
                            (showValidationErrors() && !range.location
                              ? ' [&_.custom-input]:!border-negative-default [&_.custom-input]:!border'
                              : '')
                          "
                          [id]="'location-' + range.id"
                          [model]="range.location"
                          (modelChange)="onLocationInput(rangeIndex, $event)"
                          [placeholder]="'interview.slots.create.locationPlaceholder' | translate"
                          [errorEnabled]="false"
                        />
                        @if (showValidationErrors() && !range.location) {
                          <jhi-validation-message message="interview.slots.create.validation.locationRequired.detail" styleClass="ml-5" />
                        }
                      </div>
                    </div>

                    <!-- Generated Slots List -->
                    @if (range.slots.length > 0 && range.type === 'range') {
                      <div class="flex flex-col gap-2 pt-2">
                        @for (slot of range.slots; track $index; let slotIndex = $index) {
                          <div
                            class="flex flex-col gap-1 rounded-md border border-border-default bg-background-default px-3 py-2"
                            [class.border-negative-default]="conflictingSlotKeys().has(range.id + '_' + slotIndex)"
                          >
                            <div class="flex items-center justify-between">
                              <div class="flex items-center gap-2 text-xs font-medium text-text-primary font-bold">
                                <span> {{ slot.startDateTime | date: 'HH:mm' }} - {{ slot.endDateTime | date: 'HH:mm' }} </span>
                              </div>
                              <jhi-button
                                severity="danger"
                                variant="text"
                                icon="trash"
                                size="xs"
                                (click)="removeSlot(rangeIndex, slotIndex)"
                              />
                            </div>
                            @if (allConflicts().has(range.id + '_' + slotIndex)) {
                              <span class="text-xs font-medium text-negative-default">
                                <fa-icon [icon]="['fas', 'exclamation-triangle']" class="mr-1" />
                                @switch (allConflicts().get(range.id + '_' + slotIndex)?.type) {
                                  @case ('BATCH_INTERNAL') {
                                    {{ 'interview.slots.create.validation.conflict' | translate }}
                                    @if (allConflicts().get(range.id + '_' + slotIndex)?.displayTime) {
                                      ({{ allConflicts().get(range.id + '_' + slotIndex)?.displayTime }})
                                    }
                                  }
                                  @case ('SAME_PROCESS') {
                                    {{
                                      'interview.slots.create.validation.conflictSameProcess'
                                        | translate: { time: allConflicts().get(range.id + '_' + slotIndex)?.displayTime }
                                    }}
                                  }
                                  @case ('BOOKED_OTHER_PROCESS') {
                                    {{
                                      'interview.slots.create.validation.conflictBookedOther'
                                        | translate: { time: allConflicts().get(range.id + '_' + slotIndex)?.displayTime }
                                    }}
                                  }
                                }
                              </span>
                            }
                          </div>
                        }
                      </div>
                    } @else if (range.startTime && range.endTime && range.startTime.getTime() >= range.endTime.getTime()) {
                      <jhi-validation-message message="interview.slots.create.validation.endBeforeStart" />
                    } @else if (range.type === 'range' && (!range.startTime || !range.endTime)) {
                      <span class="mt-1 text-xs font-medium text-text-secondary">
                        {{ 'interview.slots.create.addStartAndEndTime' | translate }}
                      </span>
                    } @else if (range.type === 'range' && range.startTime && range.endTime && range.slots.length === 0) {
                      <jhi-validation-message
                        message="interview.slots.create.validation.rangeTooShort"
                        [translationParams]="{ duration: range.duration }"
                      />
                    }

                    <!-- Conflict Error (Single Slot) -->
                    @if (range.type === 'single' && allConflicts().has(range.id + '_0')) {
                      <span class="mt-1 text-xs font-medium text-negative-default">
                        <fa-icon [icon]="['fas', 'exclamation-triangle']" class="mr-1" />
                        @switch (allConflicts().get(range.id + '_0')?.type) {
                          @case ('BATCH_INTERNAL') {
                            {{ 'interview.slots.create.validation.conflict' | translate }}
                            @if (allConflicts().get(range.id + '_0')?.displayTime) {
                              ({{ allConflicts().get(range.id + '_0')?.displayTime }})
                            }
                          }
                          @case ('SAME_PROCESS') {
                            {{
                              'interview.slots.create.validation.conflictSameProcess'
                                | translate: { time: allConflicts().get(range.id + '_0')?.displayTime }
                            }}
                          }
                          @case ('BOOKED_OTHER_PROCESS') {
                            {{
                              'interview.slots.create.validation.conflictBookedOther'
                                | translate: { time: allConflicts().get(range.id + '_0')?.displayTime }
                            }}
                          }
                        }
                      </span>
                    }
                  </div>
                }
              </div>
            </div>
          }
        }
      </div>

      @if (showApplyAll()) {
        <div class="mt-4 pt-3 border-t border-border-default flex items-center">
          <jhi-button
            [label]="'interview.slots.create.sameSlotsForAllDays'"
            [shouldTranslate]="true"
            variant="outlined"
            size="xs"
            severity="primary"
            (click)="applyAll.emit(true)"
          />
        </div>
      }
    </div>
  }
</div>
