name: Build and Push Docker Image
# The name of this workflow (Build) should be in sync with the test-e2e.yml workflow's workflow_run listener.

on:
  pull_request:
    paths-ignore:
      - 'README.md'
      - 'CODE_OF_CONDUCT.md'
      - 'CONTRIBUTING.md'
      - 'LICENSE'
      - 'SECURITY.md'
      - 'docs/**'
      - '.github/**'
      - '!.github/workflows/build.yml'
  push:
    branches:
      - main
    tags: '[0-9]+.[0-9]+.[0-9]+'
    paths-ignore:
      - 'README.md'
      - 'CODE_OF_CONDUCT.md'
      - 'CONTRIBUTING.md'
      - 'LICENSE'
      - 'SECURITY.md'
      - 'docs/**'
      - '.github/**'
      - '!.github/workflows/build.yml'
  release:
    types:
      - created

jobs:
  debug-vars:
    runs-on: ubuntu-latest
    environment: test-server
    steps:
      - name: Output non-sensitive ENV vars for debugging
        run: |
          echo "KEYCLOAK_URL=${{ vars.KEYCLOAK_URL }}"
  build:
    name: Build and Push
    runs-on: ubuntu-latest
    needs: debug-vars
    environment: test-server
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate environment.override.ts
        run: |
          node prebuild.mjs

      - name: Check environment.override.ts file
        run: |
          FILE=src/main/webapp/app/environments/environment.override.ts
          if [ -f "$FILE" ]; then
            echo "‚úÖ environment.override.ts found."
            echo "üîç Showing content (first 3 lines):"
            head -n 3 "$FILE"
          else
            echo "‚ùå environment.override.ts not found."
            exit 1
          fi

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ghcr.io/ls1intum/tum-apply:latest
          build-args: |
            KEYCLOAK_URL=${{ vars.KEYCLOAK_URL }}
            KEYCLOAK_REALM=${{ vars.KEYCLOAK_REALM }}
            KEYCLOAK_CLIENT_ID=${{ vars.KEYCLOAK_CLIENT_ID }}
            KEYCLOAK_ENABLE_LOGGING=${{ vars.KEYCLOAK_ENABLE_LOGGING }}
